# -*- coding: utf_8 -*-
"""执行行为分析。"""
import logging
from pathlib import Path

from django.conf import settings

from mobsf.MobSF.utils import (
    append_scan_status,
)

logger = logging.getLogger(__name__)


def analyze(checksum, sast, data):
    """执行行为分析。"""
    try:
        root = Path(settings.BASE_DIR) / 'MalwareAnalyzer' / 'views'
        rules = root / 'android' / 'rules' / 'behaviour_rules.yaml'
        msg = 'Android 行为分析已开始'
        logger.info(msg)
        append_scan_status(checksum, msg)
        behaviour_finds = sast.run_rules(data, rules.as_posix())
        msg = 'Android 行为分析已完成'
        logger.info(msg)
        append_scan_status(checksum, msg)
        return behaviour_finds
    except Exception as exp:
        msg = '执行行为分析失败'
        logger.exception(msg)
        append_scan_status(checksum, msg, repr(exp))
    return {}